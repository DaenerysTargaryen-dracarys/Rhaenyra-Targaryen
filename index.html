<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Link Generator</title>

  <!-- Light / white background, simple clean style -->
  <style>
    :root{
      --page-bg: #ffffff;
      --panel-bg: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb;
      --border: #e6e9ee;
      --shadow: 0 6px 20px rgba(16,24,40,0.06);
      --btn-bg: #2563eb;
      --text: #0f172a;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

    .wrap{max-width:980px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr;gap:18px}
    header.app-header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:10px;background:linear-gradient(180deg, #ffffff, #fbfdff);border:1px solid var(--border);box-shadow:var(--shadow)}
    header h1{margin:0;font-size:18px;font-weight:700}
    header .sub{color:var(--muted);font-size:13px}

    .panel{
      background:var(--panel-bg);
      border:1px solid var(--border);
      padding:16px;border-radius:10px;box-shadow:var(--shadow)
    }

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .file-input{display:none}
    .file-pill{padding:9px 12px;border-radius:8px;border:1px dashed var(--border);background:#fbfdff;color:var(--muted);font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:14px;background:var(--btn-bg);color:#fff;transition:transform .12s ease, background .12s ease}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border)}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted);font-size:13px}

    .results{
      background:var(--panel-bg);
      padding:12px;border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow)
    }

    .results-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .results-head h2{margin:0;font-size:16px}
    .tag{background:#f1f5f9;color:var(--text);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;border:1px solid var(--border)}

    /* Table */
    table{width:100%;border-collapse:collapse;background:transparent}
    thead th{font-size:12px;color:var(--muted);text-transform:uppercase;text-align:left;padding:12px 10px;border-bottom:1px solid var(--border)}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}
    .receipt{font-weight:700;color:var(--text)}
    .sales{color:var(--muted)}
    .action{display:flex;gap:8px}
    .action .copy-btn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--accent);cursor:pointer;font-weight:700}
    .action .copy-btn.disabled{opacity:0.5;cursor:not-allowed;color:var(--muted)}
    .small{font-size:13px;padding:8px 10px;border-radius:8px}

    .empty{padding:28px;text-align:center;color:var(--muted)}
    footer.app-foot{margin-top:8px;text-align:center;color:var(--muted);font-size:13px}

    @media (max-width:720px){
      .controls{flex-direction:column;align-items:stretch}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="app-header">
      <div>
        <h1>Link Generator</h1>
        <div class="sub">Generate survey links from Excel receipts</div>
      </div>
      <div class="muted">Store • Horamavu</div>
    </header>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div>
          <div style="font-weight:700;margin-bottom:6px">Upload Excel</div>
          <div class="muted" style="font-size:13px">Supports .xlsx and .xls</div>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
          <label class="file-pill" title="Select file">
            <input id="fileInput" class="file-input" type="file" accept=".xlsx,.xls" />
            Choose file
          </label>
          <div id="fileName" class="muted">No file chosen</div>
        </div>
      </div>

      <div style="margin-top:12px" class="controls">
        <button id="generateBtn" class="btn" disabled>Generate</button>
        <button id="copyAllBtn" class="btn secondary" disabled>Copy All</button>
        <button id="exportBtn" class="btn secondary" disabled>Export CSV</button>
        <button id="clearBtn" class="btn secondary">Clear</button>
      </div>

      <div style="margin-top:12px" class="muted">Progress: <span id="progressText">Idle</span></div>
    </div>

    <div class="results">
      <div class="results-head">
        <h2>Generated Links</h2>
        <div id="resultsCount" class="tag">0 Links</div>
      </div>

      <!-- Table with headers: Order ID, Sales Type, Action -->
      <div id="tableWrap">
        <table aria-label="generated links table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Sales Type</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="linkTableBody">
            <!-- rows inserted here -->
          </tbody>
        </table>

        <div id="emptyState" class="empty">No data processed yet. Upload an Excel file to get started.</div>
      </div>
    </div>

    <footer class="app-foot">Survey Link Generator • All systems operational</footer>
  </div>

  <!-- XLSX library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // show only Sales Type (no visible link), table headers: Order ID, Sales Type, Action, white background
    let currentData = [];
    let copiedLinks = new Set(JSON.parse(localStorage.getItem("copiedLinks") || "[]"));
    const storeID = "91KDIPL879-01";

    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const exportBtn = document.getElementById('exportBtn');
    const progressText = document.getElementById('progressText');
    const linkTableBody = document.getElementById('linkTableBody');
    const emptyState = document.getElementById('emptyState');
    const resultsCount = document.getElementById('resultsCount');

    // file selection
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (f) {
        fileNameEl.textContent = f.name;
        generateBtn.disabled = false;
        setProgress('File selected');
      } else {
        fileNameEl.textContent = 'No file chosen';
        generateBtn.disabled = true;
        setProgress('Idle');
      }
    });

    generateBtn.addEventListener('click', processFile);
    clearBtn.addEventListener('click', clearData);
    copyAllBtn.addEventListener('click', copyAllLinks);
    exportBtn.addEventListener('click', exportToCSV);

    function setProgress(text){
      progressText.textContent = text;
    }

    function processFile(){
      const file = fileInput.files[0];
      if (!file) { setProgress('Select an Excel file first'); return; }

      setProgress('Reading file...');
      generateBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = function(e){
        setProgress('Processing...');
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

          currentData = rows.map(r => ({ ...r, link: generateSurveyLink(r) }));
          renderTable();

          setProgress(`Processed ${rows.length} rows`);
        } catch (err) {
          console.error(err);
          setProgress('Error processing file — check the format');
        } finally {
          generateBtn.disabled = false;
        }
      };

      reader.onerror = function(){
        setProgress('Failed to read file');
        generateBtn.disabled = false;
      };

      reader.readAsArrayBuffer(file);
    }

    function renderTable(){
      linkTableBody.innerHTML = '';
      const visible = currentData.filter(r => r.link);
      if (visible.length === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }

      visible.forEach((row, index) => {
        const tr = document.createElement('tr');

        // Order ID column
        const td1 = document.createElement('td');
        td1.className = 'receipt';
        td1.textContent = row['Receipt No.'] || 'N/A';
        tr.appendChild(td1);

        // Sales Type column (only type — no link preview)
        const td2 = document.createElement('td');
        td2.className = 'sales';
        td2.textContent = row['Sales Type'] || 'N/A';
        tr.appendChild(td2);

        // Action column: copy button (copies the generated link to clipboard)
        const td3 = document.createElement('td');
        td3.className = 'action';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = copiedLinks.has(row.link) ? 'Copied' : 'Copy';
        if (copiedLinks.has(row.link)) {
          copyBtn.classList.add('disabled');
          copyBtn.disabled = true;
        } else {
          copyBtn.addEventListener('click', () => copySingleLink(row.link, copyBtn));
        }
        td3.appendChild(copyBtn);
        tr.appendChild(td3);

        linkTableBody.appendChild(tr);
      });

      // enable/disable bulk actions
      const linkCount = visible.length;
      resultsCount.textContent = `${linkCount} Links`;
      copyAllBtn.disabled = linkCount === 0;
      exportBtn.disabled = linkCount === 0;
      copyAllBtn.classList.toggle('disabled', linkCount === 0);
      emptyState.style.display = linkCount === 0 ? 'block' : 'none';
    }

    function clearData(){
      currentData = [];
      linkTableBody.innerHTML = '';
      emptyState.style.display = 'block';
      fileInput.value = '';
      fileNameEl.textContent = 'No file chosen';
      generateBtn.disabled = true;
      copyAllBtn.disabled = true;
      exportBtn.disabled = true;
      resultsCount.textContent = '0 Links';
      setProgress('Idle');
    }

    function copyToClipboard(text){
      return new Promise((resolve,reject) => {
        if (navigator.clipboard && window.isSecureContext){
          navigator.clipboard.writeText(text).then(resolve).catch(() => fallbackCopy(text) ? resolve() : reject());
        } else {
          fallbackCopy(text) ? resolve() : reject();
        }
      });
    }

    function fallbackCopy(text){
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch(e) {
        console.error('fallback copy failed', e);
        return false;
      }
    }

    function copySingleLink(link, buttonEl){
      copyToClipboard(link).then(() => {
        copiedLinks.add(link);
        localStorage.setItem('copiedLinks', JSON.stringify([...copiedLinks]));
        buttonEl.textContent = 'Copied';
        buttonEl.disabled = true;
        buttonEl.classList.add('disabled');
        setProgress('Link copied to clipboard');
      }).catch(err => {
        console.error(err);
        setProgress('Copy failed — try manual copy');
      });
    }

    function copyAllLinks(){
      const all = currentData.map(r => r.link).filter(Boolean).join("\n");
      if (!all) { setProgress('No links to copy'); return; }

      copyToClipboard(all).then(() => {
        currentData.forEach(r => r.link ? copiedLinks.add(r.link) : null);
        localStorage.setItem('copiedLinks', JSON.stringify([...copiedLinks]));
        renderTable();
        setProgress('All links copied to clipboard');
      }).catch(err => {
        console.error(err);
        setProgress('Failed to copy all links');
      });
    }

    function exportToCSV(){
      let csv = "Receipt No.,Sales Type,Generated Link\n";
      currentData.forEach(r => {
        if (r.link) {
          const rec = (r['Receipt No.']||'').toString().replace(/"/g,'""');
          const sales = (r['Sales Type']||'').toString().replace(/"/g,'""');
          csv += `"${rec}","${sales}","${r.link}"\n`;
        }
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "survey_links.csv"; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      setProgress('CSV exported');
    }

    // Link generation logic (unchanged)
    function generateSurveyLink(row) {
      const receipt = row['Receipt No.'];
      const sales = row['Sales Type'];
      if (!receipt || !sales) return null;

      let SM = '', OI = '', OT = '';

      if (receipt.startsWith('K281') && sales === 'TAKEAWAY') {
        SM = '4.0'; OI = receipt.slice(-4); OT = '2';
      } else if (receipt.startsWith('K281') && sales === 'DINE-IN') {
        SM = '4.0'; OI = receipt.slice(-4); OT = '1';
      } else if (receipt.startsWith('K281') && sales === 'DELIVERY') {
        SM = '3.0'; OI = receipt; OT = '3';
      } else {
        return null;
      }

      const D = convertExcelDate(row['Date']);
      const TM = convertExcelTime(row['Time']);
      const PH = `91${row['Sell-to Contact No.'] || ''}`;
      const DTM = `${D}T${TM}Z`;

      const data = {
        "S": storeID,
        "OI": OI,
        "D": D,
        "TM": TM,
        "DTM": DTM,
        "TI": OI,
        "OT": OT,
        "SM": SM,
        "PH": PH
      };

      return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${btoa(JSON.stringify(data))}`;
    }

    function convertExcelDate(serial) {
      if (!serial || isNaN(serial)) return "";
      const date = new Date((serial - 25569) * 86400 * 1000);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function convertExcelTime(serial) {
      if (!serial || isNaN(serial)) return "";
      const totalMs = Math.round(serial * 24 * 60 * 60 * 1000);
      const h = String(Math.floor(totalMs / (60 * 60 * 1000))).padStart(2, '0');
      const m = String(Math.floor((totalMs % (60 * 60 * 1000)) / (60 * 1000))).padStart(2, '0');
      const s = String(Math.floor((totalMs % (60 * 1000)) / 1000)).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // init
    (function init(){
      emptyState.style.display = 'block';
      setProgress('Idle');
      if (currentData.length === 0) {
        copyAllBtn.disabled = true;
        exportBtn.disabled = true;
      }
    })();
  </script>
</body>
</html>
