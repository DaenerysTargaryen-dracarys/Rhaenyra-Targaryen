<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House of Winter</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap" rel="stylesheet">

<style>
/* --- BODY & BACKGROUND --- */
body {
  margin: 0;
  padding: 0;
  font-family: 'Cinzel', serif;
  background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=80') no-repeat center center/cover;
  color: #e6f7ff;
  text-align: center;
  min-height: 100vh;
  position: relative;
}
body::before {
  content: "";
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: linear-gradient(to bottom, rgba(43,72,115,0.6), rgba(21,40,66,0.85));
  z-index:-1;
  pointer-events:none;
}

/* --- HEADING --- */
h1 {
  margin: 20px 0;
  font-size: 3rem;
  text-shadow: 2px 2px 12px #193059, 0 0 8px #aee2ff;
  letter-spacing: 3px;
  color: #e6f7ff;
  animation: fadeIn 2s ease-in-out;
}

/* --- CONTAINER --- */
.container {
  background: rgba(21,40,66,0.9);
  border-radius: 20px;
  max-width: 900px;
  margin: 20px auto;
  padding: 25px;
  box-shadow: 0 0 30px #60a9e6;
  border: 2px solid #aee2ff;
  backdrop-filter: blur(6px);
  animation: slideDown 1.5s ease;
}

/* --- BUTTONS --- */
button {
  margin: 5px;
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  background: linear-gradient(145deg, #60a9e6, #aee2ff);
  color: #193059;
  box-shadow: 0 4px 10px #60a9e6;
}
button:hover {
  transform: scale(1.08);
  background: linear-gradient(145deg, #aee2ff, #60a9e6);
  box-shadow: 0 6px 14px #aee2ff;
}

.btn-primary { background: linear-gradient(145deg, #60a9e6, #aee2ff); color:#fff; }
.btn-warning { background: linear-gradient(145deg, #f7b267, #ffcc7a); color:#fff; }
.btn-success { background: linear-gradient(145deg, #5de0e6, #8ff3ff); color:#fff; }

/* --- INPUT --- */
input[type="file"] {
  margin: 10px;
  padding: 8px;
  border-radius: 10px;
  border: none;
  background: rgba(255,255,255,0.2);
  color: #e6f7ff;
}

/* --- TABLE --- */
table {
  width: 100%;
  border-collapse: collapse;
  background: rgba(43,72,115,0.8);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 10px #60a9e6;
}
th, td {
  padding: 12px;
  border: 1px solid #aee2ff;
  color: #e6f7ff;
  text-align: center;
  transition: background 0.3s;
}
th {
  background: #193059;
  color: #aee2ff;
  letter-spacing: 1.5px;
}
tr:hover td {
  background: rgba(78, 123, 191, 0.5);
}

/* --- SNOWFLAKES --- */
.snowflake {
  position: fixed;
  top: -50px;
  color: #fff;
  font-size: 1.5em;
  pointer-events: none;
  animation: snowFall linear infinite;
}

/* --- ANIMATIONS --- */
@keyframes snowFall { 0% { top:-50px; } 100% { top:100vh; } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideDown { from { transform:translateY(-50px); opacity:0; } to { transform:translateY(0); opacity:1; } }

</style>
</head>
<body>

<h1>House of Winter ‚ùÑÔ∏èüêâ</h1>

<!-- Snowflakes -->
<span class="snowflake" style="left: 10%;">‚ùÑ</span>
<span class="snowflake" style="left: 30%; animation-delay: 2s;">‚ùÖ</span>
<span class="snowflake" style="left: 50%; font-size:2em; animation-delay: 1.2s;">‚ùÜ</span>
<span class="snowflake" style="left: 70%; animation-delay: 3.1s;">‚ùÑ</span>
<span class="snowflake" style="left: 90%; font-size:2em; animation-delay: 0.8s;">‚ùÖ</span>

<div class="container">
  <div class="file-section">
    <h3>Upload Excel File</h3>
    <input type="file" id="fileInput" accept=".xlsx, .xls">
    <div class="button-group">
      <button class="btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate Links</button>
      <button class="btn-warning" onclick="clearData()">Clear All</button>
    </div>
  </div>

  <div id="status" class="status" style="display: none;"></div>

  <div class="button-group">
    <button class="btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
    <button class="btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>
  </div>

  <div class="table-container">
    <table id="linkTable">
      <thead>
        <tr>
          <th>Receipt No.</th>
          <th>Sales Type</th>
          <th>Generated Link</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- XLSX library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let currentData = [];
const storeID = "91KDIPL879-01";

// Excel converters
function convertExcelDate(serial) {
  const date = new Date((serial - 25569) * 86400 * 1000);
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function convertExcelTime(serial) {
  const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
  const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
  const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
  const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
  return `${hours}:${minutes}:${seconds}`;
}

// Generate link
function generateSurveyLink(row) {
  const receiptNo = row['Receipt No.'];
  const salesType = row['Sales Type'];
  let surveyModel='', orderID='', numericOT='';

  if(/^\d+$/.test(receiptNo) && salesType==='TAKEAWAY'){surveyModel='6.0'; orderID=receiptNo; numericOT='2';}
  else if(/^\d+$/.test(receiptNo) && salesType==='DINE-IN'){surveyModel='6.0'; orderID=receiptNo; numericOT='1';}
  else if(receiptNo.startsWith('K281') && salesType==='TAKEAWAY'){surveyModel='4.0'; orderID=receiptNo.slice(-4); numericOT='2';}
  else if(receiptNo.startsWith('K281') && salesType==='DINE-IN'){surveyModel='4.0'; orderID=receiptNo.slice(-4); numericOT='1';}
  else if(receiptNo.startsWith('K281') && salesType==='DELIVERY'){surveyModel='3.0'; orderID=receiptNo; numericOT='3';}
  else return null;

  const date=convertExcelDate(row['Date']);
  const time=convertExcelTime(row['Time']);
  const phoneNumber=`91${row['Sell-to Contact No.']}`;
  const isoDateTime=`${date}T${time}Z`;
  const data={"S":storeID,"OI":orderID,"D":date,"TM":time,"DTM":isoDateTime,"TI":orderID,"OT":numericOT,"SM":surveyModel,"PH":phoneNumber};
  return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${btoa(JSON.stringify(data))}`;
}

// File upload
document.getElementById('fileInput').addEventListener('change',function(e){
  document.getElementById('generateBtn').disabled=false;
});

function processFile(){
  const file=document.getElementById('fileInput').files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheetName=workbook.SheetNames[0];
    const sheet=workbook.Sheets[sheetName];
    const rows=XLSX.utils.sheet_to_json(sheet);

    currentData=rows.map(row=>{
      const link=generateSurveyLink(row);
      return {...row, link};
    });

    renderTable();
  };
  reader.readAsArrayBuffer(file);
}

function renderTable(){
  const tbody=document.querySelector("#linkTable tbody");
  tbody.innerHTML='';
  currentData.forEach((row)=>{
    if(row.link){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${row['Receipt No.']}</td>
        <td>${row['Sales Type']}</td>
        <td><a href="${row.link}" target="_blank">Open Link</a></td>
        <td><button onclick="copyLink('${row.link}')">Copy</button></td>
      `;
      tbody.appendChild(tr);
    }
  });
  document.getElementById('copyAllBtn').disabled=false;
  document.getElementById('exportBtn').disabled=false;
}

function clearData(){
  currentData=[];
  document.querySelector("#linkTable tbody").innerHTML='';
  document.getElementById('copyAllBtn').disabled=true;
  document.getElementById('exportBtn').disabled=true;
}

function copyLink(link){ navigator.clipboard.writeText(link).then(()=>alert("Link copied!")); }
function copyAllLinks(){ navigator.clipboard.writeText(currentData.map(r=>r.link).join("\n")).then(()=>alert("All links copied!")); }

function exportToCSV(){
  let csv="Receipt No.,Sales Type,Generated Link\n";
  currentData.forEach(r=>{ if(r.link)csv+=`${r['Receipt No.']},${r['Sales Type']},${r.link}\n`; });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download="survey_links.csv";
  a.click();
}

// Snowflake animation duration
document.querySelectorAll('.snowflake').forEach(flake=>{
  flake.style.animationDuration=`${5+Math.random()*6}s`;
});
</script>

</body>
</html>
